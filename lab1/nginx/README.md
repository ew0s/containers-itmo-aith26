## Лабораторная работа №1

Написать два Dockerfile – плохой и хороший. Написать две плохие практики по использованию контейнеров
Описание
Плохой Dockerfile должен запускаться и работать корректно, но в нём должно быть не менее 3 “bad practicesˮ. В хорошем они должны быть исправлены. В Readme описать все плохие практики из кода Dockerfile и почему они плохие, как они были исправлены в хорошем Dockerfile, а также две плохие практики по использованию этого контейнера. Написать два случая, когда НЕ стоит использовать контейнеры в целом
Монтирование volume в контейнере - обязательно.

### Описание Dockerfile'ов

#### Файл Dockerfile.bad

1. **Использование тега `latest`**  
   Базовый образ указан как `nginx:latest`, что делает сборку **недетерминированной**. При пересборке спустя время может быть использована новая версия nginx, несовместимая с модулем VTS. Это нарушает воспроизводимость и может привести к неожиданным ошибкам в production.

2. **Отсутствие многоступенчатой сборки**  
   Все этапы — установка зависимостей, компиляция и финальный запуск — выполняются в **одном слое**. В результате в финальный образ попадают **инструменты сборки** (`gcc`, `make`, `git`, `curl` и др.), что **увеличивает размер образа** и **повышает поверхность атаки**.

3. **Недетерминированная сборка модуля**  
   Модуль `nginx-module-vts` клонируется без фиксации версии или коммита (`git clone` без `checkout`). Это означает, что при каждой новой сборке может использоваться **разная версия модуля**, что нарушает стабильность и предсказуемость поведения приложения.

4. **Сборка и установка происходят в runtime-образе (без separation of concerns)**
    Все этапы — установка build-инструментов, компиляция, финальный запуск — происходят в одном образе. Это противоречит best practice: build- и runtime-окружения должны быть разделены (обычно через multi-stage сборку).

5. **Запуск от привилегированного пользователя `root`**  
   В Dockerfile **не создаётся отдельный пользователь** для запуска nginx, поэтому процесс работает от имени `root`. Это представляет **серьёзную уязвимость безопасности**: в случае компрометации nginx злоумышленник получит root-доступ внутри контейнера.

6. **Отсутствие объявления `VOLUME` для логов**  
    Несмотря на то, что логи пишутся в /var/log/nginx, в Dockerfile нет объявления VOLUME ["/var/log/nginx"]. Это скрывает тот факт, что данные должны храниться вне контейнера, и увеличивает риск потери логов при удалении контейнера — нарушение принципа statelessness.

7. **Неочищенный build-контекст: остатки в /tmp**
После сборки не удаляются временные файлы (/tmp/nginx-..., /tmp/nginx-module-vts). Это увеличивает размер образа, оставляет артефакты сборки в финальном слое.


```
docker build -f Dockerfile.bad -t nginx-vts .
```

```
docker run -d \
  --name nginx-vts2 \
  -p 8080:80 \
  -v nginx-logs:/var/log/nginx \
  nginx-vts
```

```
curl http://localhost:8080/status
# → должен открыться HTML-дашборд

curl http://localhost:8080/status/format/json
# → валидный JSON с метриками
```

#### Файл Dockerfile.good

...

## Плохие практики в `Dockerfile.bad` и их исправление в `Dockerfile.good`

| № | Плохая практика в `Dockerfile.bad` | Почему это плохо | Как исправлено в `Dockerfile.good` |
|---|------------------------------------|------------------|-------------------------------------|
| 1 | **Использование тега `latest`**<br>`FROM nginx:latest` | Образ становится **недетерминированным**: при пересборке может использоваться новая версия nginx, несовместимая с модулем VTS. Это нарушает воспроизводимость и стабильность. | |
| 2 | **Отсутствие многоступенчатой сборки**<br>Все действия — установка зависимостей, сборка, запуск — в одном слое | Build-зависимости (`gcc`, `make`, `git`, `curl` и др.) **остаются в финальном образе**, увеличивая его размер и поверхность атаки. |  |
| 3 | **Модуль VTS клонируется без фиксации версии**<br>`git clone https://github.com/vozlt/nginx-module-vts.git` | Сборка **недетерминирована**: при каждом запуске может использоваться разный коммит, что может привести к несовместимости или поломке. |  |
| 4 | **Сборка и установка происходят в runtime-образе**<br>Нет разделения build- и runtime-окружений. | Нарушается принцип separation of concerns: финальный образ содержит артефакты сборки и не оптимизирован для запуска в production.|
| 5 | **Запуск от root-пользователя**<br>Пользователь `nginx` не создаётся | Если nginx будет скомпрометирован, злоумышленник получит **root-доступ внутри контейнера**, что критично для безопасности. | |
| 6 | **Не используется volume для логов** (в Dockerfile) | Логи пишутся внутрь контейнера и **теряются при его удалении**, что нарушает best practice statelessness. |  |
| 6 | **Неочищенный build-контекст**<br>Остатки сборки в /tmp не удаляются.| Временные файлы (/tmp/nginx-..., /tmp/nginx-module-vts) остаются в финальном слое, увеличивая размер образа и оставляя ненужные артефакты.| |

